# LYLY PDF Generator

## 概要
CSVからアクリルパネル・LEDスタンド・アクリル時計・アクリルブロック等のカスタム商品用PDFを生成するPHPシステム。

## 技術スタック
- PHP 8.x
- TCPDF + FPDI (PDF生成・編集)
- Yasumi (日本の祝日計算)
- 日本語フォント対応

## フォルダ構成
| フォルダ/ファイル | 説明 |
|------------------|------|
| `download/` | ダウンロードした画像ファイル |
| `draft/` | 印刷用PDF（最終出力） |
| `temp/` | 個別のデザインPDF |
| `parts/` | 各デザイン用のパーツPDF |
| `include/` | PHPライブラリ |
| `end_order.txt` | 完了済みリスト |
| `log.txt` | エラーログ |

## 重要ファイル
| ファイル | 役割 |
|----------|------|
| `config.php` | テンプレート定義、DRAFTS_XYS座標、設定定数 |
| `include/lyly.php` | PDF生成エンジン（メイン処理） |
| `run.php` | CLI実行エントリポイント |
| `parts/*.pdf` | PDFテンプレートベース（119個） |

## 使い方
1. `run.bat`にCSVファイルをドラッグ＆ドロップ
2. または: `php run.php CSVファイル名.csv`

## 命名規則
| 表記 | 意味 |
|------|------|
| `text` | 白枠、白文字 |
| `futa` | 白の蓋（二度塗り用） |
| `fullcolor` | フルカラー |

### ⚠️ レイヤー重ね合わせ（重要）

1つの商品は **futa → text → fullcolor** の3枚を重ねて1枚のデータになる。

- `s_text` / `s_fullcolor` / `s_futa` / `s_led_futa` → **全て同一座標を共有**
- `m_text` / `m_fullcolor` / `m_futa` → **全て同一座標を共有**
- `tokei_fullcolor` / `tokei_futa` → **全て同一座標を共有**
- `block_text` / `block_fullcolor` / `block_futa` / `block_futa100` → **全て同一座標を共有**

**座標調整時の注意:**
- 同じグループ内は必ず同じ調整値を適用すること
- 個別に調整するとレイヤーがズレて印刷不良になる

### 座標ズレ測定方法

ガイドラインPDFと重ねてズレを測定する際：
- ✅ **「枠中心に対するデザイン中心の差」** を使用
- ❌ 「はみ出し量」は調整値として使いにくい

## 厳守事項

### 1. DRAFTS_XYS座標は変更禁止
- `config.php` 647-661行目の座標は印刷用PDFの配置位置
- 変更すると全体がずれる
- 変更が必要な場合は必ずユーザーに確認

### 2. Rotate関数は慎重に扱う
- 回転処理は座標ずれの原因になりやすい
- 必ず `StartTransform()` / `StopTransform()` で囲む
- 回転軸は要素の中心点 `(x + w/2, y + h/2)`

### 3. 1機能ずつ変更→テスト
- 複数の変更を同時にしない
- 変更後は必ず `php run.php` でPDF生成テスト
- draft/フォルダの出力を目視確認

### 4. 変更前に必ずgit commit
- バックアップなしで変更しない

## 座標システム
- **単位**: mm（ミリメートル）
- **DRAFTS_XYS**: ドキュメント中央からの相対座標
  - 正の値: 右/下
  - 負の値: 左/上
- **テンプレート座標**: 左上基準

### ⚠️ ROTATE処理による座標軸の入れ替わり（重要）

`ROTATE=1`の場合、最終PDFは90度回転されるため、**座標軸が入れ替わる**。

**回転後のPDFで見た移動方向 → 回転前のDRAFTS_XYS座標の調整:**

| 回転後の移動方向 | DRAFTS_XYS調整 |
|------------------|----------------|
| **右へ** 移動    | Y座標を **+**（増加） |
| **左へ** 移動    | Y座標を **-**（減少） |
| **上へ** 移動    | X座標を **+**（増加） |
| **下へ** 移動    | X座標を **-**（減少） |

**例:** 回転後のPDFで「右へ4mm、上へ7mm」移動したい場合
```php
// 誤り（直感的だが間違い）
[X + 4, Y - 7]

// 正解（回転を考慮）
[X + 7, Y + 4]
```

**座標調整の手順:**
1. ガイドラインオーバーレイでズレを測定（回転後のPDFで）
2. 測定結果を上記の表に従って変換
3. DRAFTS_XYS座標を調整

## 主要関数（include/lyly.php）
| 関数 | 行 | 機能 |
|------|-----|------|
| `create_pdf_one()` | 168 | 個別PDF生成 |
| `create_pdf()` | 436 | 印刷用PDF生成 |
| `rotate()` | 604 | PDF全体90度回転 |
| `rotate_one()` | 631 | PDF全体270度回転 |

## 動作確認コマンド
```bash
php run.php
# → temp/ に個別PDF
# → draft/ に印刷用PDF
```

## デザイン種類
- **アクリルパネル系**: インスタ、シンプル、ミュージック、カメラ、カレンダー、ベビー、6枚、オルタネイト、ペット、4枚（各S/M）
- **LEDスタンドパネル**: インスタ、シンプル、ミュージック
- **アクリル時計**: 黒、白
- **アクリルブロック**: 通常、4枚、ミュージック、コラージュ

各デザインは3種類の出力形式に対応:
- `_text`: テキストのみ
- `_fullcolor`: フルカラー
- `_futa`: 二度塗り用（黒埋め）
